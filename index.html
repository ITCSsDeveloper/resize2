<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description"
        content="Resize images online for free! Quickly adjust the size and dimensions of JPG, PNG, and WebP files to fit any social media or web requirements. Start now!">
    <meta name="robots" content="noindex, nofollow">
    <title>Image Resize</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css" rel="stylesheet" />

    <style>
        body {
            background: #f6f7f9;
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            color: #23272f;
        }

        .container-fluid {
            max-width: 1100px;
        }

        h1 {
            font-weight: 700;
            letter-spacing: 0.5px;
            color: #23272f;
            margin-bottom: 2.5rem;
        }

        .card {
            border-radius: 16px;
            border: none;
            box-shadow: 0 2px 12px 0 rgba(30, 41, 59, 0.06);
            background: #fff;
            transition: box-shadow 0.2s;
        }

        .card:hover {
            box-shadow: 0 6px 24px 0 rgba(30, 41, 59, 0.10);
        }

        .card-header {
            border-radius: 16px 16px 0 0 !important;
            font-weight: 600;
            font-size: 1.08rem;
            background: transparent !important;
            color: #23272f !important;
            border-bottom: none;
            padding-bottom: 0.5rem;
        }

        .card-body {
            background: #fff;
            border-radius: 0 0 16px 16px;
            padding-top: 1.1rem;
            padding-bottom: 1.1rem;
        }

        .form-label {
            font-weight: 500;
            color: #475569;
            margin-bottom: 0.3rem;
        }

        .form-select,
        .btn {
            border-radius: 10px;
            font-size: 1rem;
            border: 1.5px solid #e5e7eb;
            background: #f8fafc;
            color: #23272f;
            transition: border-color 0.2s, background 0.2s;
        }

        .form-select:focus,
        .btn:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px #6366f133;
            background: #fff;
        }

        .btn-lg {
            font-size: 1.08rem;
            padding: 0.7rem 1.5rem;
            font-weight: 500;
        }

        .btn-success,
        .btn-info {
            background: #6366f1 !important;
            color: #fff !important;
            border: none;
            box-shadow: 0 2px 8px 0 rgba(99, 102, 241, 0.08);
            transition: background 0.2s, box-shadow 0.2s;
        }

        .btn-success:hover,
        .btn-info:hover {
            background: #4338ca !important;
            box-shadow: 0 4px 16px 0 rgba(99, 102, 241, 0.15);
        }

        .btn-secondary {
            background: #e5e7eb !important;
            color: #23272f !important;
            border: none;
        }

        .btn-secondary:hover {
            background: #cbd5e1 !important;
            color: #23272f !important;
        }

        .btn-primary {
            background: #23272f !important;
            color: #fff !important;
            border: none;
        }

        .btn-primary:hover {
            background: #6366f1 !important;
            color: #fff !important;
        }

        .dropzone {
            border: 2px dashed #e5e7eb;
            border-radius: 14px;
            background: #f8fafc;
            padding: 32px 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            min-height: 160px;
        }

        .dropzone:hover,
        .dropzone.dz-drag-hover {
            border-color: #6366f1;
            background: #f1f5f9;
        }

        .dz-message h4 {
            color: #6366f1;
            font-weight: 600;
            font-size: 1.15rem;
        }

        .dz-message p {
            color: #64748b;
            font-size: 0.98rem;
        }

        .image-preview-item {
            border: 1.5px solid #e5e7eb;
            border-radius: 12px;
            padding: 10px 8px 8px 8px;
            margin-bottom: 14px;
            background: #f8fafc;
            box-shadow: 0 1px 4px 0 rgba(99, 102, 241, 0.04);
            transition: box-shadow 0.2s;
        }

        .image-preview-item:hover {
            box-shadow: 0 4px 16px 0 rgba(99, 102, 241, 0.10);
        }

        .image-preview-item img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto 10px auto;
            border-radius: 8px;
            box-shadow: 0 1px 4px 0 rgba(99, 102, 241, 0.06);
        }

        .image-preview-item .btn {
            border-radius: 8px;
            font-size: 0.97rem;
            padding: 0.32rem 0.9rem;
        }

        #output-previews {
            background: #f8fafc;
            border: 1.5px solid #e5e7eb;
            border-radius: 12px;
        }

        @media (max-width: 767.98px) {
            .column-container {
                flex-direction: column;
            }

            .column {
                margin-bottom: 20px;
            }
        }

        .dz-progress {
            display: none !important;
        }

        #output-previews {
            scrollbar-width: thin;
            scrollbar-color: #6366f1 #f8fafc;
        }

        #output-previews::-webkit-scrollbar {
            width: 8px;
        }

        #output-previews::-webkit-scrollbar-thumb {
            background: #6366f1;
            border-radius: 8px;
        }

        #output-previews::-webkit-scrollbar-track {
            background: #f8fafc;
        }

        #image-dropzone .dz-preview {
            width: 80px;
            height: 80px;
            margin: 8px;
            display: inline-block;
            vertical-align: top;
        }

        #image-dropzone .dz-image {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            overflow: hidden;
        }

        #image-dropzone .dz-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        #image-dropzone {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            min-height: 160px;
            max-height: 220px;
            overflow-y: auto;
            padding-bottom: 8px;
        }

        #image-dropzone .dz-message {
            width: 100%;
            flex-basis: 100%;
        }

        footer {
            background: none;
            color: #64748b;
            font-size: 1rem;
            border-top: none;
            margin-top: 2.5rem;
        }

        footer img {
            filter: grayscale(1) brightness(0.7);
        }

        .dz-details {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="processing-error-toast" class="toast align-items-center text-bg-danger border-0" role="alert"
            aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
            <div class="d-flex">
                <div class="toast-body" id="toast-message-body">
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                    aria-label="Close"></button>
            </div>
        </div>
    </div>

    <div class="container-fluid my-4">
        <br />
        <h1 class="text-center mb-4">Image Resize</h1>
        <div class="row column-container g-4">
            <div class="col-lg-4 col-md-12 column">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Input Images</h5>
                        <button id="reset-button" class="btn btn-sm btn-warning" type="button"
                            title="Reload to restart">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </button>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <div id="image-dropzone"
                            class="dropzone d-flex justify-content-center align-items-center flex-grow-1">
                            <div class="dz-message needsclick">
                                <h4 class="text-secondary">
                                    Drag & Drop images here or click to upload
                                </h4>
                                <p class="text-muted">(Supports multiple image files)</p>
                            </div>
                        </div>
                        <div>
                            <p id="count_select">You've selected 0/0 files.</p>
                            <p id="file_warning_message"></p>
                        </div>
                        <div>
                            <label class="form-label mt-3">Supported formats include:</label><br>
                            <span id="file_support_tags"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-12 column">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Settings & Convert</h5>
                    </div>
                    <div class="card-body d-flex flex-column justify-content-center">
                        <div class="mb-3">
                            <label for="resize-size" class="form-label">Resize to (Mpx):</label>
                            <select id="resize-size" class="form-select">
                                <option value="2">2 M</option>
                                <option value="4">4 M</option>
                                <option value="6">6 M</option>
                                <option value="8">8 M</option>
                                <option value="10">10 M</option>
                                <option value="12">12 M</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="jpeg-quality" class="form-label">JPEG Quality (%):</label>
                            <select id="jpeg-quality" class="form-select">
                                <option value="100">100%</option>
                                <option value="80">80%</option>
                                <option value="75">75%</option>
                                <option value="50">50%</option>
                                <option value="25">25%</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="sharpness" class="form-label">Sharpness (%):</label>
                            <div class="d-flex align-items-center">
                                <input type="range" id="sharpness" class="form-range me-3" min="0" max="100" value="0"
                                    step="1" style="width: 70%;">
                                <span id="sharpness-value" style="min-width: 40px;">0%</span>
                            </div>
                        </div>
                        <button id="convert-button" class="btn btn-success btn-lg mt-auto">
                            <span id="convert-spinner" class="spinner-border spinner-border-sm d-none" role="status"
                                aria-hidden="true"></span>
                            <span id="convert-text">Convert</span>
                        </button>
                        <hr />
                        <div class="mb-3 text-center">
                            <label class="form-label">Quick Convert:</label>
                            <button id="fb-ig-convert-btn" class="btn btn-primary btn-lg w-100 mb-2">
                                For Facebook &amp; IG (2048px)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-12 column">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Output & Download</h5>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <div id="output-previews" class="flex-grow-1 overflow-auto p-2 border rounded"
                            style="max-height: 500px">
                            <p class="text-muted text-center">
                                Resized images will appear here...
                            </p>
                        </div>
                        <button id="save-all-button" class="btn btn-info btn-lg mt-3" style="display: none">
                            <span id="save-spinner" class="spinner-border spinner-border-sm d-none" role="status"
                                aria-hidden="true"></span>
                            <span id="save-text">Download All (.zip)</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center py-4 mt-5">
        <div class="d-flex flex-column flex-md-row justify-content-center align-items-center gap-3">
            <div>
                <span class="fw-semibold text-primary">itcss-dev.com</span><br>
                <span class="text-secondary">&copy; 2025</span>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script>
        Dropzone.autoDiscover = false;
        const FILE_LIMIT = 30;
        const IMAGE_EXTENSIONS_ARRAY = [".jpg", ".jpeg", ".png", ".webp"];
        const uploadedFiles = [];
        const convertedFiles = [];

        // Utility: Show error toast
        function showErrorToast(message) {
            const toastElement = document.getElementById('processing-error-toast');
            const toastBody = document.getElementById('toast-message-body');
            if (toastElement && toastBody) {
                toastBody.textContent = message;
                new bootstrap.Toast(toastElement).show();
            }
        }

        // Utility: Update file count and warning
        function updateFileCount() {
            const countElement = document.getElementById('count_select');
            const warningElement = document.getElementById('file_warning_message');
            const currentCount = uploadedFiles.length;
            if (countElement) {
                countElement.textContent = `You've selected ${currentCount}/${FILE_LIMIT} files.`;
                countElement.style.color = currentCount > FILE_LIMIT ? 'red' : '';
                if (warningElement) {
                    warningElement.innerHTML = currentCount > FILE_LIMIT
                        ? `<span class="text-bg-danger">Warning: Large file counts (${currentCount} files) may slow down processing.</span>`
                        : '';
                }
            }
        }

        // Utility: Update supported file tags
        function updateSupportTags() {
            const container = document.getElementById('file_support_tags');
            if (container) {
                container.innerHTML = IMAGE_EXTENSIONS_ARRAY
                    .map(ext => `<span class="badge rounded-pill text-bg-primary me-1">${ext.toUpperCase()}</span>`)
                    .join('');
            }
        }

        // Utility: Load image from file
        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Utility: Resize image and return File & DataURL
        async function resizeImage(img, fileName, width, height, quality, suffix = '_resized', sharpness = 0) {
            let canvas;
            if (sharpness > 0) {
                canvas = webglSharpen(img, width, height, sharpness);
            } else {
                canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
            }
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', quality));
            const newFileName = fileName.replace(/\.[^/.]+$/, "") + `${suffix}.jpg`;
            const resizedFile = new File([blob], newFileName, { type: 'image/jpeg', lastModified: Date.now() });
            const dataUrl = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.readAsDataURL(resizedFile);
            });
            return { file: resizedFile, dataUrl };
        }

        // Utility: Create preview element
        function createPreview({ file, dataUrl }) {
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item card my-2';
            previewItem.innerHTML = `
            <div class="card-body">
                <img src="${dataUrl}" class="img-fluid mb-2" alt="Resized image preview">
                <p class="card-text text-muted small">${file.name}</p>
                <button class="btn btn-sm btn-primary view-image me-2" data-src="${dataUrl}">View</button>
                <button class="btn btn-sm btn-secondary save-image" data-filename="${file.name}" data-src="${dataUrl}">Save</button>
            </div>
        `;
            return previewItem;
        }

        // Utility: Reset all selections and previews
        function resetAll() {
            const dropzoneElement = document.getElementById('image-dropzone');
            const myDropzone = Dropzone.forElement(dropzoneElement);
            if (myDropzone) {
                myDropzone.removeAllFiles(true);
            }
            uploadedFiles.length = 0;
            window.location.reload();
        }

        // Utility: Sharpen image using WebGL
        function webglSharpen(img, width, height, sharpness) {
            // Create canvas and get WebGL context
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (!gl) return null;

            // Vertex shader
            const vsSource = `
        attribute vec2 a_position;
        attribute vec2 a_texCoord;
        varying vec2 v_texCoord;
        void main() {
            gl_Position = vec4(a_position, 0, 1);
            v_texCoord = a_texCoord;
        }
    `;
            // Fragment shader with sharpen kernel
            const fsSource = `
        precision mediump float;
        varying vec2 v_texCoord;
        uniform sampler2D u_image;
        uniform float u_sharp;
        uniform vec2 u_texSize;
        void main() {
            vec2 onePixel = 1.0 / u_texSize;
            vec4 color = texture2D(u_image, v_texCoord) * (1.0 + 4.0 * u_sharp);
            color -= texture2D(u_image, v_texCoord + onePixel * vec2(0, 1)) * u_sharp;
            color -= texture2D(u_image, v_texCoord + onePixel * vec2(0, -1)) * u_sharp;
            color -= texture2D(u_image, v_texCoord + onePixel * vec2(1, 0)) * u_sharp;
            color -= texture2D(u_image, v_texCoord + onePixel * vec2(-1, 0)) * u_sharp;
            gl_FragColor = color;
        }
    `;
            function compileShader(type, source) {
                const shader = gl.createShader(type);
                gl.shaderSource(shader, source);
                gl.compileShader(shader);
                return shader;
            }
            const vs = compileShader(gl.VERTEX_SHADER, vsSource);
            const fs = compileShader(gl.FRAGMENT_SHADER, fsSource);
            const program = gl.createProgram();
            gl.attachShader(program, vs);
            gl.attachShader(program, fs);
            gl.linkProgram(program);
            gl.useProgram(program);

            // Set up rectangle covering the canvas
            const positionBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
                -1, -1,  1, -1,  -1, 1,
                -1,  1,  1, -1,   1, 1
            ]), gl.STATIC_DRAW);
            const positionLoc = gl.getAttribLocation(program, 'a_position');
            gl.enableVertexAttribArray(positionLoc);
            gl.vertexAttribPointer(positionLoc, 2, gl.FLOAT, false, 0, 0);

            // Texture coordinates (แก้ไขให้ตรงกับ Canvas: flip Y)
            const texCoordBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, texCoordBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
                0, 1, 1, 1, 0, 0,
                0, 0, 1, 1, 1, 0
            ]), gl.STATIC_DRAW);
            const texCoordLoc = gl.getAttribLocation(program, 'a_texCoord');
            gl.enableVertexAttribArray(texCoordLoc);
            gl.vertexAttribPointer(texCoordLoc, 2, gl.FLOAT, false, 0, 0);

            // Upload image as texture
            const texture = gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D, texture);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);

            // Set uniforms
            gl.uniform1f(gl.getUniformLocation(program, 'u_sharp'), sharpness / 100.0 * 0.5); // scale sharpness
            gl.uniform2f(gl.getUniformLocation(program, 'u_texSize'), width, height);

            // Draw
            gl.viewport(0, 0, width, height);
            gl.drawArrays(gl.TRIANGLES, 0, 6);

            return canvas;
        }

        // Initialize Dropzone and event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const dropzoneElement = document.getElementById('image-dropzone');
            const convertButton = document.getElementById('convert-button');
            const saveAllButton = document.getElementById('save-all-button');
            const outputPreviews = document.getElementById('output-previews');
            const resizeSizeSelect = document.getElementById('resize-size');
            const jpegQualitySelect = document.getElementById('jpeg-quality');
            const sharpnessRange = document.getElementById('sharpness');
            const sharpnessValue = document.getElementById('sharpness-value');
            const fbIgConvertBtn = document.getElementById('fb-ig-convert-btn');
            const resetButton = document.getElementById('reset-button');

            updateFileCount();
            updateSupportTags();

            // แสดงค่า sharpness ขณะเลื่อน
            sharpnessRange.addEventListener('input', () => {
                sharpnessValue.textContent = `${sharpnessRange.value}%`;
            });
            sharpnessValue.textContent = `${sharpnessRange.value}%`;

            // Dropzone setup
            new Dropzone(dropzoneElement, {
                url: "#",
                autoProcessQueue: false,
                acceptedFiles: IMAGE_EXTENSIONS_ARRAY.join(','),
                addRemoveLinks: true,
                maxFiles: 1000,
                dictMaxFilesExceeded: "You can only upload a maximum of 1000 files.",
                init: function () {
                    this.on("addedfile", file => {
                        if (this.files.length > this.options.maxFiles) {
                            this.removeFile(file);
                            return;
                        }
                        const fileName = file.name.toLowerCase();
                        const isSupported = IMAGE_EXTENSIONS_ARRAY.some(ext => fileName.endsWith(ext));
                        if (!isSupported) {
                            this.removeFile(file);
                            showErrorToast(`Unsupported file type: ${file.name}`);
                            return;
                        }
                        uploadedFiles.push(file);
                        updateFileCount();
                    });
                    this.on("removedfile", file => {
                        const index = uploadedFiles.indexOf(file);
                        if (index > -1) {
                            uploadedFiles.splice(index, 1);
                            updateFileCount();
                        }
                    });
                }
            });

            // Main Convert button
            convertButton.addEventListener('click', async () => {
                if (uploadedFiles.length === 0) {
                    showErrorToast("Please upload at least one image.");
                    return;
                }
                const convertSpinner = document.getElementById('convert-spinner');
                const convertText = document.getElementById('convert-text');
                convertSpinner.classList.remove('d-none');
                convertText.textContent = "Converting...";
                convertButton.disabled = true;

                convertedFiles.length = 0;
                outputPreviews.innerHTML = '';

                const targetMpx = parseFloat(resizeSizeSelect.value);
                const jpegQuality = parseInt(jpegQualitySelect.value, 10) / 100;
                const sharpness = parseInt(sharpnessRange.value, 10);
                const targetPx = Math.sqrt(targetMpx * 1000000);

                for (const file of uploadedFiles) {
                    try {
                        const img = await loadImage(file);
                        let { width, height } = img;
                        const aspect = width / height;
                        if (width >= height) {
                            width = targetPx;
                            height = Math.round(targetPx / aspect);
                        } else {
                            height = targetPx;
                            width = Math.round(targetPx * aspect);
                        }
                        const result = await resizeImage(img, file.name, width, height, jpegQuality, '_resized', sharpness);
                        convertedFiles.push(result);
                        outputPreviews.appendChild(createPreview(result));
                    } catch (error) {
                        console.error("Error during image resize:", error);
                        showErrorToast(`An error occurred while processing ${file.name}.`);
                    }
                }
                convertSpinner.classList.add('d-none');
                convertText.textContent = "Convert";
                convertButton.disabled = false;
                saveAllButton.style.display = 'block';
            });

            // Output preview: View & Save buttons
            outputPreviews.addEventListener('click', (event) => {
                if (event.target.classList.contains('view-image')) {
                    const dataSrc = event.target.dataset.src;
                    fetch(dataSrc)
                        .then(res => res.blob())
                        .then(blob => {
                            const blobUrl = URL.createObjectURL(blob);
                            window.open(blobUrl, '_blank');
                            setTimeout(() => URL.revokeObjectURL(blobUrl), 10000);
                        });
                } else if (event.target.classList.contains('save-image')) {
                    const fileName = event.target.dataset.filename;
                    const dataSrc = event.target.dataset.src;
                    fetch(dataSrc)
                        .then(res => res.blob())
                        .then(blob => saveAs(blob, fileName))
                        .catch(() => showErrorToast("Could not save the image."));
                }
            });

            // Save All (.zip)
            saveAllButton.addEventListener('click', async () => {
                if (convertedFiles.length === 0) {
                    showErrorToast("No files to download.");
                    return;
                }
                const saveSpinner = document.getElementById('save-spinner');
                const saveText = document.getElementById('save-text');
                saveSpinner.classList.remove('d-none');
                saveText.textContent = "Zipping...";
                saveAllButton.disabled = true;

                const zip = new JSZip();
                convertedFiles.forEach(item => zip.file(item.file.name, item.file));
                const zipBlob = await zip.generateAsync({ type: "blob" });
                saveAs(zipBlob, "resized_images.zip");

                saveSpinner.classList.add('d-none');
                saveText.textContent = "Download All (.zip)";
                saveAllButton.disabled = false;
            });

            // Quick Convert for Facebook & IG
            fbIgConvertBtn?.addEventListener('click', async () => {
                if (uploadedFiles.length === 0) {
                    showErrorToast("Please upload at least one image.");
                    return;
                }
                const convertSpinner = document.getElementById('convert-spinner');
                const convertText = document.getElementById('convert-text');
                convertSpinner.classList.remove('d-none');
                convertText.textContent = "Converting...";
                convertButton.disabled = true;
                fbIgConvertBtn.disabled = true;

                convertedFiles.length = 0;
                outputPreviews.innerHTML = '';

                const targetPx = 2048;
                const quality = 0.90;

                for (const file of uploadedFiles) {
                    try {
                        const img = await loadImage(file);
                        let { width, height } = img;
                        let newWidth = width, newHeight = height;
                        if (width > height) {
                            newWidth = targetPx;
                            newHeight = Math.round(targetPx * height / width);
                        } else {
                            newHeight = targetPx;
                            newWidth = Math.round(targetPx * width / height);
                        }
                        const result = await resizeImage(img, file.name, newWidth, newHeight, quality, '_fb-ig_90');
                        convertedFiles.push(result);
                        outputPreviews.appendChild(createPreview(result));
                    } catch (error) {
                        console.error("Error during FB/IG image resize:", error);
                        showErrorToast(`An error occurred while processing ${file.name}.`);
                    }
                }
                convertSpinner.classList.add('d-none');
                convertText.textContent = "Convert";
                convertButton.disabled = false;
                fbIgConvertBtn.disabled = false;
                saveAllButton.style.display = 'block';
            });

            // Reset button
            resetButton.addEventListener('click', () => {
                resetAll();
            });
        });

        // Warn before leaving if files are uploaded
        window.addEventListener('beforeunload', function (e) {
            if (uploadedFiles.length > 0) {
                e.preventDefault();
                e.returnValue = `You have selected ${uploadedFiles.length} files that have not been processed. Are you sure you want to leave?`;
                return e.returnValue;
            }
        });
    </script>
</body>

</html>